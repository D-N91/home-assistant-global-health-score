# HAGHS - Home Assistant Global Health Score v2.0.0
# Naming Convention: Area: Object - Function

- sensor:
      - name: "System: HA - Global Health Score"
        unique_id: system_ha_global_health_score
        icon: mdi:shield-check
        # === CONFIGURATION ===
        variables:
          # Hardware IDs
          cpu_id: 'sensor.system_monitor_YOUR_ID'
          ram_id: 'sensor.system_monitor_YOUR_ID'
          disk_id: 'sensor.system_monitor_YOUR_ID'
          # Software / Maintenance IDs
          core_update_id: 'update.home_assistant_core_update'
          db_size_id: 'sensor.home_assistant_v2_db'
          log_size_id: 'sensor.home_assistant_log'
          # Label Logic
          ignore_label: 'haghs_ignore' 
        # =====================

        state: >
          {# 1. PILLAR: HARDWARE (40%) #}
          {% set cpu = states(cpu_id) | float(0) %}
          {% set ram = states(ram_id) | float(0) %}
          {% set disk = states(disk_id) | float(0) %}

          {# Heavyweight CPU Tiers #}
          {% if cpu <= 10 %} {% set cpu_penalty = 0 %}
          {% elif cpu <= 15 %} {% set cpu_penalty = 10 %}
          {% elif cpu <= 25 %} {% set cpu_penalty = 25 %}
          {% elif cpu <= 50 %} {% set cpu_penalty = 50 %}
          {% else %} {% set cpu_penalty = 80 %}
          {% endif %}

          {% set cpu_score = 100 - cpu_penalty %}
          {% set ram_score = 100 if ram < 70 else ([0, (100 - (ram - 70) * 3.33), 100] | sort)[1] %}
          {% set disk_score = 100 if disk < 80 else ([0, (100 - (disk - 80) * 5), 100] | sort)[1] %}
          {% set hardware_final = (cpu_score + ram_score + disk_score) / 3 %}

          {# 2. PILLAR: APPLICATION (60%) #}
          {% set domains = ['sensor', 'binary_sensor', 'switch', 'light', 'fan', 'climate', 'media_player', 'vacuum', 'camera'] %}
          
          {# A. ZOMBIE & LABEL FILTER #}
          {% set ignored_ids = label_entities(ignore_label) %}
          {% set ignored_device_ids = label_devices(ignore_label) %}
          {% set ns = namespace(device_entities=[]) %}
          {% for dev_id in ignored_device_ids %}
            {% set ns.device_entities = ns.device_entities + device_entities(dev_id) %}
          {% endfor %}
          {% set all_ignored = ignored_ids + ns.device_entities %}
          
          {% set zombies = states | selectattr('domain', 'in', domains) 
            | selectattr('state', 'in', ['unavailable', 'unknown']) 
            | rejectattr('entity_id', 'search', 'integration_health')
            | rejectattr('entity_id', 'in', all_ignored) 
            | list %}
          {% set zombie_penalty = ([0, (zombies | count * 2), 20] | sort)[1] %}
          
          {# B. INTEGRATION HEALTH #}
          {% set failed_integrations = states.sensor 
            | selectattr('entity_id', 'search', 'integration_health') 
            | selectattr('state', 'eq', 'unhealthy') | list | count %}
          {% set integration_penalty = ([0, (failed_integrations * 5), 15] | sort)[1] %}

          {# C. MAINTENANCE HYGIENE (DB & LOGS) #}
          {# Database: >1000MB is Warn, >2500MB is Critical #}
          {% set db_mb = states(db_size_id) | float(0) %}
          {% if db_mb < 1000 %} {% set db_penalty = 0 %}
          {% elif db_mb < 2500 %} {% set db_penalty = 10 %}
          {% else %} {% set db_penalty = 30 %}
          {% endif %}
          
          {# Logs: >25MB means heavy spamming/errors #}
          {% set log_mb = states(log_size_id) | float(0) %}
          {% if log_mb < 20 %} {% set log_penalty = 0 %}
          {% elif log_mb < 100 %} {% set log_penalty = 10 %}
          {% else %} {% set log_penalty = 25 %}
          {% endif %}
          
          {# D. UPDATES & BACKUPS #}
          {% set backup_stale = 30 if is_state('binary_sensor.backups_stale', 'on') else 0 %}
          
          {% set update_count = states.update | selectattr('state', 'eq', 'on') | list | count %}
          {% set core_lag_penalty = 0 %}
          {% set current = state_attr(core_update_id, 'installed_version') %}
          {% set latest = state_attr(core_update_id, 'latest_version') %}
          {% if current and latest and '.' in current and '.' in latest %}
            {% set cur_parts = current.split('.') %}
            {% set lat_parts = latest.split('.') %}
            {% if cur_parts|length >= 2 and lat_parts|length >= 2 %}
              {% set cur_months = (cur_parts[0]|int * 12) + cur_parts[1]|int %}
              {% set lat_months = (lat_parts[0]|int * 12) + lat_parts[1]|int %}
              {% if (lat_months - cur_months) >= 2 %}{% set core_lag_penalty = 20 %}{% endif %}
            {% endif %}
          {% endif %}
          {% set total_update_penalty = ([0, (update_count * 5) + core_lag_penalty, 35] | sort)[1] %}
          
          {# APP CALCULATION #}
          {% set app_final = 100 - zombie_penalty - integration_penalty - backup_stale - total_update_penalty - db_penalty - log_penalty %}

          {{ (([0, (hardware_final * 0.4) + (app_final * 0.6), 100] | sort)[1]) | int }}

        attributes:
          zombie_entities: >
            {% set ignore_label = 'haghs_ignore' %}
            {% set ignored_ids = label_entities(ignore_label) %}
            {% set ignored_device_ids = label_devices(ignore_label) %}
            {% set ns = namespace(device_entities=[]) %}
            {% for dev_id in ignored_device_ids %}
              {% set ns.device_entities = ns.device_entities + device_entities(dev_id) %}
            {% endfor %}
            {% set all_ignored = ignored_ids + ns.device_entities %}
            
            {% set domains = ['sensor', 'binary_sensor', 'switch', 'light', 'fan', 'climate', 'media_player', 'vacuum', 'camera'] %}
            {% set zombies = states | selectattr('domain', 'in', domains) 
              | selectattr('state', 'in', ['unavailable', 'unknown']) 
              | rejectattr('entity_id', 'search', 'integration_health')
              | rejectattr('entity_id', 'in', all_ignored)
              | map(attribute='entity_id') | list %}
            
            {{ zombies | join(', ') if zombies | count > 0 else 'None' }}
          
          recommendations: >
            {% set cpu_val = states(cpu_id) | float(0) %}
            {% set disk_val = states(disk_id) | float(0) %}
            {% set db_mb = states(db_size_id) | float(0) %}
            {% set log_mb = states(log_size_id) | float(0) %}
            {% set update_count = states.update | selectattr('state', 'eq', 'on') | list | count %}
            
            {% set advice = [] %}
            {% if cpu_val > 25 %}{% set advice = advice + ["âš¡ Optimization: CPU load is impacting the score (" ~ cpu_val ~ "%)."] %}{% endif %}
            {% if disk_val > 80 %}{% set advice = advice + ["âš ï¸ Disk Space: Drive full (>80%). Clean up!"] %}{% endif %}
            {% if db_mb > 1000 %}{% set advice = advice + ["ðŸ—„ï¸ Database: Huge DB (" ~ (db_mb/1000)|round(1) ~ " GB). Check Recorder excludes."] %}{% endif %}
            {% if log_mb > 25 %}{% set advice = advice + ["ðŸ“œ Log File: Large Logs (" ~ log_mb|int ~ " MB). Errors detected?"] %}{% endif %}
            {% if is_state('binary_sensor.backups_stale', 'on') %}{% set advice = advice + ["ðŸš¨ Security: Stale backup detected!"] %}{% endif %}
            {% if update_count > 0 %}{% set advice = advice + ["ðŸ“¦ Maintenance: " ~ update_count ~ " update(s) pending."] %}{% endif %}
            
            {{ advice | join('\n') if advice | count > 0 else "âœ… System optimized "}}
            
